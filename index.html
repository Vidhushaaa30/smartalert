<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neighbourhood Smart Alert System (Local Storage) with Images</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .moderator-list { max-height: 70vh; overflow-y: auto; }
        .moderator-list::-webkit-scrollbar { width: 8px; }
        .moderator-list::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 4px; }
        .moderator-list::-webkit-scrollbar-track { background: #e2e8f0; }
        /* Style for the notification card entrance */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification-card-animate {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-5xl bg-white shadow-2xl rounded-2xl p-8 transition-all duration-300">
        <h1 class="text-4xl font-extrabold text-center mb-6 text-indigo-700">Neighbourhood Smart Alert System</h1>
        <div id="auth-status" class="text-xs text-right text-gray-500 mb-4">
            User ID: <span id="user-id-display" class="font-mono text-gray-700">Initializing...</span>
        </div>
        <div id="content-area">
            <p class="text-center text-indigo-600 font-semibold p-8">Loading application...</p>
        </div>
    </div>

    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div id="notification-card" class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center notification-card-animate">
            <p id="notification-message" class="text-xl font-bold mb-4 text-gray-800"></p>
            <button onclick="hideNotification()" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">Dismiss</button>
        </div>
    </div>

    <script type="text/javascript">
        // Global Constants
        const MODERATOR_PASSCODE = 'admin42';
        const STORAGE_KEY = 'neighbourhood_issues';
        
        // Global State 
        window.state = {
            // Generates a unique ID for the client session (simulates user login)
            userId: 'CLIENT_ID_' + Math.random().toString(36).substring(2, 8).toUpperCase(), 
            role: 'anonymous',
            issues: [], // Data cache for current issues
        };

        // --- LOCAL STORAGE FUNCTIONS ---

        function loadIssues() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                window.state.issues = data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error loading issues from localStorage:", error);
                window.state.issues = [];
            }
        }

        function saveIssues() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(window.state.issues));
            } catch (error) {
                console.error("Error saving issues to localStorage:", error);
            }
        }

        function getPendingIssues() {
            return window.state.issues.filter(issue => issue.status === 'PENDING');
        }

        function generateUniqueId() {
            // Simple ID generation for local storage
            return Date.now().toString() + Math.random().toString(36).substring(2, 5);
        }

        // --- UTILITY & UI FUNCTIONS ---

        function showNotification(message) {
            const modal = document.getElementById('notification-modal');
            document.getElementById('notification-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideNotification() {
            const modal = document.getElementById('notification-modal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        function renderView(htmlContent, viewFunction) {
            document.getElementById('content-area').innerHTML = htmlContent;
            window.currentView = viewFunction;
            document.getElementById('user-id-display').textContent = window.state.userId || 'N/A';
        }

        /**
         * Converts a File object to a Base64 string.
         * @param {File} file - The image file to convert.
         * @returns {Promise<string>} A promise that resolves with the Base64 string.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }


        // --- VIEWS ---

        window.renderLoginView = function() {
            window.currentView = window.renderLoginView;
            
            const loginHtml = `
                <div class="space-y-8 max-w-md mx-auto p-8 bg-gray-50 rounded-2xl shadow-xl border border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-800 text-center">Welcome!</h2>
                    
                    <button onclick="window.renderUserView()" class="w-full flex items-center justify-center p-4 bg-emerald-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-emerald-700 transition duration-150 transform hover:scale-[1.02] active:scale-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                        Submit an Alert
                    </button>

                    <div class="text-center text-gray-400 font-medium text-sm">--- OR ---</div>

                    <div class="space-y-4">
                        <label for="passcode" class="block text-sm font-medium text-gray-700">Moderator Passcode (<span class="font-mono text-xs text-indigo-500">admin42</span>):</label>
                        <input type="password" id="passcode" placeholder="Enter Moderator Passcode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                        <button onclick="window.handleModeratorLogin()" class="w-full flex items-center justify-center p-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.02] active:scale-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.2V9a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v5a4 4 0 0 0 4 4h2"/><path d="M12 19V5a3 3 0 0 0 3 3h4a2 2 0 0 1 2 2v2"/><path d="M8 12h8"/></svg>
                            Review Alerts (Moderator)
                        </button>
                    </div>
                </div>
            `;
            renderView(loginHtml, window.renderLoginView);
        }

        window.handleModeratorLogin = function() {
            const passcode = document.getElementById('passcode').value;
            if (passcode === MODERATOR_PASSCODE) {
                window.state.role = 'moderator';
                window.renderModeratorView();
            } else {
                showNotification('Invalid Moderator Passcode.');
            }
        }

        window.renderUserView = function() {
            window.state.role = 'user';
            window.currentView = window.renderUserView;
            
            const userHtml = `
                <div class="max-w-xl mx-auto space-y-6">
                    <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                        <h2 class="text-3xl font-bold text-gray-800">Submit Neighbourhood Alert</h2>
                        <button onclick="window.renderLoginView()" class="text-sm text-gray-500 hover:text-indigo-600 transition duration-150 font-medium">← Back to Login</button>
                    </div>

                    <form id="issue-form" class="space-y-6 p-8 bg-white rounded-xl shadow-2xl border border-indigo-100">
                        <div>
                            <label for="location" class="block text-sm font-semibold text-gray-700 mb-2">Location / Address:</label>
                            <input type="text" id="location" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">Issue Description:</label>
                            <textarea id="description" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none shadow-sm" placeholder="e.g., Leaking pipe at the corner of Elm and Oak Street..."></textarea>
                        </div>
                        
                        <div>
                            <label for="imageUpload" class="block text-sm font-semibold text-gray-700 mb-2">Attach Photo (Optional):</label>
                            <input type="file" id="imageUpload" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <p class="mt-2 text-xs text-gray-500">Note: Image is stored as a Base64 string in your browser's local storage.</p>
                        </div>

                        <button type="submit" id="submit-btn" class="w-full py-3 bg-indigo-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] active:scale-100">
                            Submit Alert
                        </button>
                    </form>
                </div>
            `;
            renderView(userHtml, window.renderUserView);
            document.getElementById('issue-form').onsubmit = window.handleIssueSubmission;
        }

        window.renderModeratorView = function() {
            window.state.role = 'moderator';
            window.currentView = window.renderModeratorView;
            
            const moderatorHtml = `
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                        <h2 class="text-3xl font-bold text-indigo-600">Moderator Dashboard</h2>
                        <button onclick="window.renderLoginView()" class="text-sm text-gray-500 hover:text-indigo-600 transition duration-150 font-medium">← Logout</button>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-medium text-gray-700">Pending Alerts for Review</h3>
                        <button onclick="window.refreshModeratorView()" class="text-sm text-indigo-500 hover:text-indigo-700 font-medium transition duration-150">Refresh List</button>
                    </div>
                    
                    <div id="issues-list" class="moderator-list space-y-4 p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                        <p class="text-center text-gray-500 italic p-4">Loading issues...</p>
                    </div>
                </div>
            `;
            renderView(moderatorHtml, window.renderModeratorView);

            // Load and render issues immediately
            window.refreshModeratorView();
        }

        window.refreshModeratorView = function() {
            loadIssues(); // Ensure we have the latest data from local storage
            const issuesList = document.getElementById('issues-list');
            const pendingReports = getPendingIssues();
            renderReports(pendingReports, issuesList);
        }

        // --- LOCAL DATA HANDLING ---

        window.handleIssueSubmission = async function(e) {
            e.preventDefault();
            
            const location = document.getElementById('location').value;
            const description = document.getElementById('description').value;
            const imageInput = document.getElementById('imageUpload');
            const file = imageInput.files[0];
            const submitBtn = document.getElementById('submit-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing Image...';

            let base64Image = null;

            if (file) {
                // Check for file size limit (e.g., 5MB) before conversion, as Base64 strings can be large
                const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
                if (file.size > MAX_FILE_SIZE) {
                    showNotification('Error: Image file is too large (max 5MB recommended for local storage).');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Alert';
                    return;
                }

                try {
                    // Convert the file to Base64 string for storage
                    base64Image = await fileToBase64(file);
                    submitBtn.textContent = 'Submitting...';
                } catch (error) {
                    console.error("Error converting file to Base64:", error);
                    showNotification('Error processing image. Alert not submitted.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Alert';
                    return;
                }
            }

            try {
                const newIssue = {
                    id: generateUniqueId(),
                    location: location,
                    description: description,
                    image: base64Image, // Save Base64 string here
                    userId: window.state.userId,
                    status: 'PENDING',
                    timestamp: new Date().toISOString()
                };

                window.state.issues.push(newIssue);
                saveIssues();

                // Reset form
                document.getElementById('issue-form').reset();
                showNotification('Alert submitted successfully!');
            } catch (error) {
                console.error("Error submitting issue:", error);
                showNotification('Error submitting alert. Check console for details.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Alert';
            }
        }

        function renderReports(reports, issuesListElement) {
            if (reports.length === 0) {
                issuesListElement.innerHTML = '<p class="text-center text-gray-500 italic p-4">No pending alerts at this time.</p>';
                return;
            }

            issuesListElement.innerHTML = reports.map(report => {
                const imageSection = report.image 
                    ? `
                        <div class="mt-3">
                            <h4 class="text-xs font-semibold text-gray-700 mb-1">Attached Photo:</h4>
                            <img src="${report.image}" alt="Attached issue photo" class="w-full max-h-48 object-cover rounded-lg shadow-md border border-gray-200 cursor-pointer transition-transform duration-200 hover:scale-[1.02]" 
                                onclick="window.showImageModal('${report.image}')">
                            <p class="text-xs text-gray-400 mt-1">Click image to enlarge</p>
                        </div>
                    ` 
                    : '<p class="text-xs text-gray-400 mt-2 italic">No photo attached.</p>';

                return `
                    <div class="report-card flex flex-col gap-4 justify-between bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition duration-200 border border-indigo-100">
                        <div class="flex flex-col md:flex-row md:gap-4">
                            <div class="flex-grow space-y-1 mb-3 md:mb-0 md:w-1/2">
                                <p class="text-lg font-bold text-gray-900">${report.location}</p>
                                <p class="text-sm text-gray-600">${report.description}</p>
                                <p class="text-xs text-indigo-400 font-mono mt-2">User: ${report.userId.substring(0, 8)}... | ID: ${report.id.substring(0, 15)}...</p>
                            </div>
                            
                            <div class="md:w-1/2">
                                ${imageSection}
                            </div>
                        </div>

                        <div class="flex-shrink-0 flex space-x-3 w-full border-t pt-4 border-gray-100">
                            <button onclick="window.handleUpdateStatus('${report.id}', 'APPROVED')"
                                    class="flex-1 py-2 px-3 text-sm bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 transition duration-150 shadow-md">
                                Verify & Approve
                            </button>
                            <button onclick="window.handleUpdateStatus('${report.id}', 'REJECTED')"
                                    class="flex-1 py-2 px-3 text-sm bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                                Reject
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Image Enlargement Modal
        window.showImageModal = function(base64Image) {
            const modalHtml = `
                <div id="image-enlarge-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50" onclick="this.remove()">
                    <div class="max-w-4xl max-h-[90vh] w-full" onclick="event.stopPropagation()">
                        <img src="${base64Image}" alt="Enlarged issue photo" class="w-full h-full object-contain rounded-xl shadow-2xl">
                    </div>
                    <button class="absolute top-4 right-4 text-white text-3xl font-bold p-2 bg-black bg-opacity-50 rounded-full hover:bg-opacity-70 transition" onclick="document.getElementById('image-enlarge-modal').remove()">
                        &times;
                    </button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        window.handleUpdateStatus = function(id, status) {
            let updated = false;
            for (let i = 0; i < window.state.issues.length; i++) {
                if (window.state.issues[i].id === id) {
                    window.state.issues[i].status = status;
                    updated = true;
                    break;
                }
            }

            if (updated) {
                saveIssues();
                let message = status === 'APPROVED' 
                    ? 'Alert Verified!People have been notified.' 
                    : 'Alert Rejected. People have been notified.';
                showNotification(message);
                
                // Refresh the moderator view to remove the updated issue
                window.refreshModeratorView(); 
            } else {
                showNotification('Error: Could not find issue to update.');
            }
        }

        // --- INITIAL APP START ---
        window.onload = function() {
            loadIssues(); // Load any previously stored data on startup
            window.renderLoginView();
        }

    </script>
</body>
</html>
